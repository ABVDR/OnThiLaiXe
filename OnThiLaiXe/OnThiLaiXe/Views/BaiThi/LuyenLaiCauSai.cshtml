@model List<OnThiLaiXe.Models.CauHoi>

@{
    ViewData["Title"] = "Luyện tập câu sai";
    int currentIndex = 0;
}

<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">Ôn tập các câu sai</h3>
        </div>
        <div class="card-body">
            <p class="lead">Đây là danh sách các câu hỏi bạn đã trả lời sai trong các bài kiểm tra trước đây. Hãy luyện tập để nâng cao kết quả!</p>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge bg-info">Tổng số câu hỏi: @Model.Count</span>
                </div>
                <div>
                    <div class="btn-group">
                        <button id="prev-question" class="btn btn-outline-primary" disabled>
                            <i class="fas fa-arrow-left"></i> Câu trước
                        </button>
                        <button id="next-question" class="btn btn-outline-primary">
                            Câu tiếp theo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="progress-container" class="mb-4">
        <div class="progress" style="height: 30px;">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
        </div>
    </div>

    @foreach (var cauHoi in Model)
    {
        <div class="question-card card mb-4 @(currentIndex == 0 ? "active" : "d-none")" data-index="@currentIndex">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>Câu hỏi @(currentIndex + 1)/@Model.Count</span>
                @if (cauHoi.DiemLiet)
                {
                    <span class="badge bg-danger">Điểm liệt</span>
                }
            </div>
            <div class="card-body">
                <h5 class="card-title">@cauHoi.NoiDung</h5>

                @if (!string.IsNullOrEmpty(cauHoi.MediaUrl))
                {
                    <div class="my-3 text-center">
                        <img src="@cauHoi.MediaUrl" alt="Hình minh họa" class="img-fluid question-image" style="max-height: 300px;">
                    </div>
                }

                <div class="mt-4">
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action option" data-option="A" data-correct="@(cauHoi.DapAnDung == 'A')">
                            <span class="option-label">A</span> @cauHoi.LuaChonA
                        </button>
                        <button class="list-group-item list-group-item-action option" data-option="B" data-correct="@(cauHoi.DapAnDung == 'B')">
                            <span class="option-label">B</span> @cauHoi.LuaChonB
                        </button>

                        @if (!string.IsNullOrEmpty(cauHoi.LuaChonC))
                        {
                            <button class="list-group-item list-group-item-action option" data-option="C" data-correct="@(cauHoi.DapAnDung == 'C')">
                                <span class="option-label">C</span> @cauHoi.LuaChonC
                            </button>
                        }

                        @if (!string.IsNullOrEmpty(cauHoi.LuaChonD))
                        {
                            <button class="list-group-item list-group-item-action option" data-option="D" data-correct="@(cauHoi.DapAnDung == 'D')">
                                <span class="option-label">D</span> @cauHoi.LuaChonD
                            </button>
                        }
                    </div>
                </div>

                <div class="explanation mt-3 d-none">
                    <div class="alert alert-info">
                        <h5 class="alert-heading">Giải thích:</h5>
                        <p>Đáp án đúng: <strong>@cauHoi.DapAnDung</strong></p>
                        @if (!string.IsNullOrEmpty(cauHoi.GiaiThich))
                        {
                            <p>@cauHoi.GiaiThich</p>
                        }
                    </div>
                </div>
            </div>
        </div>
        currentIndex++;
    }

    <div class="card" id="result-container" style="display: none;">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0">Kết quả luyện tập</h4>
        </div>
        <div class="card-body">
            <div class="text-center mb-4">
                <h3>Bạn đã hoàn thành phần luyện tập!</h3>
                <div class="result-stats mt-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card bg-success text-white mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Đúng</h5>
                                    <h2 id="correct-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-danger text-white mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Sai</h5>
                                    <h2 id="wrong-count">0</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-primary text-white mb-3">
                                <div class="card-body text-center">
                                    <h5 class="card-title">Tổng điểm</h5>
                                    <h2 id="total-score">0</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <a href="@Url.Action("DanhSachCauHoiSai")" class="btn btn-primary me-2">
                    <i class="fas fa-list"></i> Xem danh sách câu sai
                </a>
                <a href="@Url.Action("LuyenLaiCauSai")" class="btn btn-success me-2">
                    <i class="fas fa-redo"></i> Luyện tập lại
                </a>
                <a href="@Url.Action("DanhSachLoaiBangLai")" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Trang chủ
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let currentQuestionIndex = 0;
            const totalQuestions = @Model.Count;
            let correctAnswers = 0;
            let wrongAnswers = 0;
            let answeredQuestions = {};

            // Hiển thị câu hỏi theo chỉ số
            function showQuestion(index) {
                $('.question-card').addClass('d-none').removeClass('active');
                $(`.question-card[data-index="${index}"]`).removeClass('d-none').addClass('active');

                // Cập nhật nút điều hướng
                $('#prev-question').prop('disabled', index === 0);
                $('#next-question').prop('disabled', index === totalQuestions - 1);

                // Cập nhật thanh tiến trình
                const progress = Math.floor((index / totalQuestions) * 100);
                $('#progress-bar').css('width', `${progress}%`).text(`${progress}%`);
            }

            // Xử lý khi chọn đáp án
            $('.option').click(function() {
                if (answeredQuestions[currentQuestionIndex]) return; // Đã trả lời câu này rồi

                const $this = $(this);
                const isCorrect = $this.data('correct') === true;
                const option = $this.data('option');

                // Đánh dấu câu hỏi đã được trả lời
                answeredQuestions[currentQuestionIndex] = {
                    option: option,
                    isCorrect: isCorrect
                };

                // Hiển thị kết quả
                $('.active .option').prop('disabled', true);

                if (isCorrect) {
                    $this.addClass('list-group-item-success');
                    correctAnswers++;
                } else {
                    $this.addClass('list-group-item-danger');
                    // Hiển thị đáp án đúng
                    $(`.active .option[data-correct="true"]`).addClass('list-group-item-success');
                    wrongAnswers++;
                }

                // Hiển thị phần giải thích
                $('.active .explanation').removeClass('d-none');

                // Tự động chuyển câu sau 2 giây nếu chưa phải câu cuối
                if (currentQuestionIndex < totalQuestions - 1) {
                    setTimeout(function() {
                        currentQuestionIndex++;
                        showQuestion(currentQuestionIndex);
                    }, 2000);
                } else {
                    // Nếu là câu cuối, hiển thị kết quả sau 2 giây
                    setTimeout(showResults, 2000);
                }
            });

            // Điều hướng giữa các câu hỏi
            $('#prev-question').click(function() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    showQuestion(currentQuestionIndex);
                }
            });

            $('#next-question').click(function() {
                if (currentQuestionIndex < totalQuestions - 1) {
                    currentQuestionIndex++;
                    showQuestion(currentQuestionIndex);
                } else {
                    showResults();
                }
            });

            // Hiển thị kết quả tổng hợp
            function showResults() {
                $('.question-card').addClass('d-none');
                $('#progress-container').hide();
                $('#result-container').show();

                $('#correct-count').text(correctAnswers);
                $('#wrong-count').text(wrongAnswers);
                $('#total-score').text(correctAnswers + '/' + totalQuestions);
            }
        });
    </script>
}